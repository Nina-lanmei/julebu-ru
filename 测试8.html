<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>小测试</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 40px; }
    .card { border: 1px solid #ccc; padding: 20px; margin: 20px auto; width: 85%; border-radius: 10px; background: #f9f9f9; }
    .word-block { display: inline-flex; align-items: center; margin: 5px; }
    .word-input { width: 120px; padding: 8px; font-size: 16px; text-align: center; }
    .punct { font-size: 18px; font-weight: bold; margin-left: 3px; }
    .correct { background: #c8f7c5; border: 1px solid #4caf50; }
    .wrong { background: #f8d7da; border: 1px solid #f44336; }
    .ru { font-size: 20px; font-weight: bold; color: #003366; margin-top: 10px; }
    .phon { font-size: 16px; color: #555; }
  </style>
</head>
<body>

<h1>📖 小测试</h1>
<p>请根据中文，把俄语句子逐词输入（标点只显示，不需要输入；点击第一个输入框将开始循环朗读）：</p>

<div id="card" class="card">
  <div id="cn"></div>
  <div id="inputs"></div>
</div>

<div id="feedback"></div>
<div id="answer" style="display:none;">
  <div id="ru" class="ru"></div>
  <div id="phon" class="phon"></div>
</div>

<script>
// 句子卡片（已修正 компании）
const cards = [
  {
    cn: "欢迎您来我们公司！",
    ru: "Мы рады приветствовать вас в нашей компании!",
    phon: "Мы ра́ды приве́тствовать вас ф на́шу кампанИю!"
  },
  {
    cn: "您一路辛苦了。",
    ru: "Надеюсь, дорога не слишком утомила вас.",
    phon: "НадЕюсь, дарОга не слИшкам утамИла вас"
  },
  {
    cn: "需要喝点水或者咖啡吗？",
    ru: "Могу предложить вам воду, чай или кофе.",
    phon: "МагУ предлажИть вам вОду, чай илʲ кОфе"
  }
];

let currentIndex = 0;
let words = [];
let allCorrect = false;
let isSpeaking = false;

// —— 工具函数 ——
// 判定时忽略大小写与常见标点（含破折号、省略号与引号）
function normalize(str) {
  return str
    .toLowerCase()
    .replace(/[.,!?;:—–…«»"()]/g, "");
}

function stopSpeaking() {
  speechSynthesis.cancel();
}

function speakLoop(text) {
  stopSpeaking();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "ru-RU";
  utter.rate = 0.7; // 0.7倍速
  utter.onend = () => { if (isSpeaking) speakLoop(text); };
  speechSynthesis.speak(utter);
}

// —— 显示中文并生成输入框 ——
// 更稳健的分词：按任意空白切分
function showChinese() {
  const card = cards[currentIndex];
  document.getElementById("cn").innerText = card.cn;
  document.getElementById("feedback").innerText = "";
  document.getElementById("answer").style.display = "none";
  stopSpeaking();
  isSpeaking = false;
  allCorrect = false;

  // 分离词尾标点：把每个“词+标点”拆为 base + punct
  // 支持多个标点叠加，比如 "кофе...?!"
  const tokenRegex = /^(.+?)([.,!?;:—–…«»"()]*)$/;
  words = card.ru.trim().split(/\s+/).map(w => {
    const m = w.match(tokenRegex);
    return { base: m ? m[1] : w, punct: m ? m[2] : "" };
  });

  const inputsDiv = document.getElementById("inputs");
  inputsDiv.innerHTML = "";

  words.forEach((w, i) => {
    const block = document.createElement("div");
    block.className = "word-block";

    const inp = document.createElement("input");
    inp.type = "text";
    inp.className = "word-input";
    inp.disabled = i !== 0;
    inp.dataset.correct = w.base;

    // 点击第一个输入框时开始循环朗读
    if (i === 0) {
      inp.addEventListener("focus", () => {
        if (!isSpeaking) { isSpeaking = true; speakLoop(card.ru); }
      });
    }

    inp.addEventListener("input", (e) => checkWord(e, inp, i));

    block.appendChild(inp);

    if (w.punct) {
      const span = document.createElement("span");
      span.className = "punct";
      span.innerText = w.punct;
      block.appendChild(span);
    }

    inputsDiv.appendChild(block);
  });
}

// —— 单词判定 ——
// 正确：当前框变绿并锁定，自动聚焦到下一个；全对后显示答案
function checkWord(e, inp, index) {
  const val = normalize(e.target.value);
  const correct = normalize(inp.dataset.correct);

  if (val === correct) {
    inp.classList.remove("wrong");
    inp.classList.add("correct");
    inp.disabled = true;

    const inputs = document.querySelectorAll(".word-input");
    if (index + 1 < inputs.length) {
      const next = inputs[index + 1];
      next.disabled = false;
      next.focus();
    } else {
      allCorrect = true;
      showAnswer();
    }
  } else {
    inp.classList.add("wrong");
  }
}

// —— 显示答案 —— 
function showAnswer() {
  const card = cards[currentIndex];
  document.getElementById("answer").style.display = "block";
  document.getElementById("ru").innerText = card.ru;
  document.getElementById("phon").innerText = card.phon;
}

// —— 切换下一句 —— 
function nextSentence() {
  currentIndex = (currentIndex + 1) % cards.length;
  showChinese();
}

// 全部正确后：回车 / 空格 跳下一句
document.addEventListener("keydown", (e) => {
  if (allCorrect && (e.key === "Enter" || e.key === " ")) {
    nextSentence();
  }
});

// 初始化
showChinese();
</script>

</body>
</html>